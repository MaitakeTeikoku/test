<!DOCTYPE html>
<html lang="ja">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <title>test</title>
</head>

<body>
    <button id="requestDeviceSensor" onclick="clickRequestDeviceSensor();">センサーの有効化</button>
    <div id="info">response: </div>
    <button id="isMathFloor" onclick="clickIsMathFloor();">小数点を切り捨てない</button>

    <h2>ジャイロ</h2>
    <div>
        α: <span id="orientationA"></span>
    </div>
    <div>
        β: <span id="orientationB"></span>
    </div>
    <div>
        γ: <span id="orientationC"></span>
    </div>

    <h2>加速度</h2>
    <div>
        x: <span id="accelerationX"></span>
    </div>
    <div>
        y: <span id="accelerationY"></span>
    </div>
    <div>
        z: <span id="accelerationZ"></span>
    </div>

    <p></p>
    <div>
        <button id="startRecord" onclick="startRecord();" disabled>記録開始</button>
        <button id="stopRecord" onclick="stopRecord();" disabled>記録終了</button>
    </div>
    <div>
        ジャイロ記録回数: <span id="orientationCount"></span>
    </div>
    <div>
        加速度記録回数: <span id="accelerationCount"></span>
    </div>
    <p></p>
    <div id="orientationChart" style="width: 1280px; height: 720px;"></div>
    <p></p>
    <div id="accelerationChart" style="width: 1280px; height: 720px;"></div>



    <script>
        var isMathFloor = true;

        var isRecord = false;
        var orientationChartData;
        var accelerationChartData;
        var orientationCount = 0;
        var accelerationCount = 0;

        //. DeviceOrientationEvent オブジェクトが有効な環境か？　をチェック
        if (window.DeviceOrientationEvent) {
            //. iOS13 以上であれば DeviceOrientationEvent.requestPermission 関数が定義されているので、ここで条件分岐
            if (DeviceOrientationEvent.requestPermission && typeof DeviceOrientationEvent.requestPermission === 'function') {
                //. iOS 13 以上の場合、
                //. 画面上部に「センサーの有効化」ボタンを表示
                document.getElementById("requestDeviceSensor").style.display = "block";
            } else {
                //. Android または iOS 13 未満の場合、
                //. DeviceOrientationEvent オブジェクトが有効な場合のみ、deviceorientation イベント発生時に deviceOrientaion 関数がハンドリングするよう登録
                window.addEventListener("deviceorientation", deviceOrientation);
                window.addEventListener('devicemotion', deviceMotion);
            }
        }

        document.getElementById('orientationCount').textContent = orientationCount;
        document.getElementById('accelerationCount').textContent = accelerationCount;



        function clickRequestDeviceSensor() {
            //. ユーザーに「許可」を求めるダイアログを表示
            DeviceOrientationEvent.requestPermission()
                .then(function (response) {
                    if (response === 'granted') {
                        //. 許可された場合のみイベントハンドラを追加できる
                        window.addEventListener("deviceorientation", deviceOrientation);
                        window.addEventListener('devicemotion', deviceMotion);
                        //. 画面上部のボタンを消す
                        document.getElementById("requestDeviceSensor").disabled = true;
                        document.getElementById("startRecord").disabled = false;
                        document.getElementById('info').textContent = "response: " + response;
                    }
                }).catch(function (e) {
                    document.getElementById('info').textContent = "e: " + e;
                });
        }

        //. deviceorientation イベントハンドラ
        function deviceOrientation(event) {
            //. 通常の処理を無効にする
            event.preventDefault();

            // 傾きの情報を取得
            const alpha = event.alpha;
            const beta = event.beta;
            const gamma = event.gamma;

            if (isMathFloor) {
                // 傾きの値を表示
                document.getElementById('orientationA').textContent = Math.floor(alpha);
                document.getElementById('orientationB').textContent = Math.floor(beta);
                document.getElementById('orientationC').textContent = Math.floor(gamma);
            } else {
                // 傾きの値を表示
                document.getElementById('orientationA').textContent = alpha;
                document.getElementById('orientationB').textContent = beta;
                document.getElementById('orientationC').textContent = gamma;
            }

            if (isRecord) {
                orientationCount++;
                document.getElementById('orientationCount').textContent = orientationCount;
                orientationChartData.push([orientationCount, alpha, beta, gamma]);
            }
        }

        // deviceMotionイベントのハンドラ
        function deviceMotion(event) {
            // 加速度の情報を取得
            const acceleration = event.acceleration;

            const x = acceleration.x;
            const y = acceleration.y;
            const z = acceleration.z;

            if (isMathFloor) {
                // 加速度の値を表示
                document.getElementById('accelerationX').textContent = Math.floor(x);
                document.getElementById('accelerationY').textContent = Math.floor(y);
                document.getElementById('accelerationZ').textContent = Math.floor(z);
            } else {
                // 加速度の値を表示
                document.getElementById('accelerationX').textContent = x;
                document.getElementById('accelerationY').textContent = y;
                document.getElementById('accelerationZ').textContent = z;
            }

            if (isRecord) {
                accelerationCount++;
                document.getElementById('accelerationCount').textContent = accelerationCount;
                accelerationChartData.push([accelerationCount, x, y, z]);
            }
        }

        function clickIsMathFloor() {
            if (isMathFloor) {
                document.getElementById('isMathFloor').textContent = "小数点を切り捨て";
                isMathFloor = false;
            } else {
                document.getElementById('isMathFloor').textContent = "小数点を切り捨てない";
                isMathFloor = true;
            }
        }

        function startRecord() {
            document.getElementById("startRecord").disabled = true;
            document.getElementById("stopRecord").disabled = false;

            orientationChartData = [['測定回', 'α', 'β', 'γ']];
            accelerationChartData = [['測定回', 'x', 'y', 'z']];

            orientationCount = 0;
            accelerationCount = 0;

            isRecord = true;
        }

        function stopRecord() {
            isRecord = false;

            document.getElementById("startRecord").disabled = false;
            document.getElementById("stopRecord").disabled = true;
            document.getElementById('orientationChart').textContent = orientationChartData;
            document.getElementById('accelerationChart').textContent = accelerationChartData;
            
            // name:visualization(可視化),version:バージョン(1),packages:パッケージ(corechart)
            google.load('visualization', '1', { 'packages': ['corechart'] });
            // グラフを描画する為のコールバック関数を指定
            google.setOnLoadCallback(drawChart);
        }

        function drawChart(id, dataChart) {
            const listData = [[orientationChartData, 'orientationChart'], [accelerationChartData, 'accelerationChart']];
            
            for (let i = 0; i < listData.length; ++i) {
                let data = new google.visualization.arrayToDataTable(listData[i][0]);

                // オプションの設定
                let options = {
                    title: "ジャイロと加速度の推移",
                    legend: {
                        position: 'top'
                    },
                    vAxis: {
                        title: '値'
                    },
                    hAxis: {
                        title: '測定回'
                    }
                };

                let chart = new google.visualization.LineChart(document.getElementById(listData[i][1]));
                chart.draw(data, options);
            }
        }

    </script>
</body>

</html>